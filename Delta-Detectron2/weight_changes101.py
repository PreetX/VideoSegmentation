changes={
  "backbone.stem.conv1.norm":"backbone.stem.norm1",
  "backbone.res2.0.shortcut.norm":"backbone.res2.0.shortcut_norm",
  "backbone.res2.0.conv1.norm":"backbone.res2.0.norm1",
  "backbone.res2.0.conv2.norm":"backbone.res2.0.norm2",
  "backbone.res2.0.conv3.norm":"backbone.res2.0.norm3",
  "backbone.res2.1.conv1.norm":"backbone.res2.1.norm1",
  "backbone.res2.1.conv2.norm":"backbone.res2.1.norm2",
  "backbone.res2.1.conv3.norm":"backbone.res2.1.norm3",
  "backbone.res2.2.conv1.norm":"backbone.res2.2.norm1",
  "backbone.res2.2.conv2.norm":"backbone.res2.2.norm2",
  "backbone.res2.2.conv3.norm":"backbone.res2.2.norm3",
  "backbone.res3.0.shortcut.norm":"backbone.res3.0.shortcut_norm",
  "backbone.res3.0.conv1.norm":"backbone.res3.0.norm1",
  "backbone.res3.0.conv2.norm":"backbone.res3.0.norm2",
  "backbone.res3.0.conv3.norm":"backbone.res3.0.norm3",
  "backbone.res3.1.conv1.norm":"backbone.res3.1.norm1",
  "backbone.res3.1.conv2.norm":"backbone.res3.1.norm2",
  "backbone.res3.1.conv3.norm":"backbone.res3.1.norm3",
  "backbone.res3.2.conv1.norm":"backbone.res3.2.norm1",
  "backbone.res3.2.conv2.norm":"backbone.res3.2.norm2",
  "backbone.res3.2.conv3.norm":"backbone.res3.2.norm3",
  "backbone.res3.3.conv1.norm":"backbone.res3.3.norm1",
  "backbone.res3.3.conv2.norm":"backbone.res3.3.norm2",
  "backbone.res3.3.conv3.norm":"backbone.res3.3.norm3",
  "backbone.res4.0.shortcut.norm":"backbone.res4.0.shortcut_norm",
  "backbone.res4.0.conv1.norm":"backbone.res4.0.norm1",
  "backbone.res4.0.conv2.norm":"backbone.res4.0.norm2",
  "backbone.res4.0.conv3.norm":"backbone.res4.0.norm3",
  "backbone.res4.1.conv1.norm":"backbone.res4.1.norm1",
  "backbone.res4.1.conv2.norm":"backbone.res4.1.norm2",
  "backbone.res4.1.conv3.norm":"backbone.res4.1.norm3",
  "backbone.res4.2.conv1.norm":"backbone.res4.2.norm1",
  "backbone.res4.2.conv2.norm":"backbone.res4.2.norm2",
  "backbone.res4.2.conv3.norm":"backbone.res4.2.norm3",
  "backbone.res4.3.conv1.norm":"backbone.res4.3.norm1",
  "backbone.res4.3.conv2.norm":"backbone.res4.3.norm2",
  "backbone.res4.3.conv3.norm":"backbone.res4.3.norm3",
  "backbone.res4.4.conv1.norm":"backbone.res4.4.norm1",
  "backbone.res4.4.conv2.norm":"backbone.res4.4.norm2",
  "backbone.res4.4.conv3.norm":"backbone.res4.4.norm3",
  "backbone.res4.5.conv1.norm":"backbone.res4.5.norm1",
  "backbone.res4.5.conv2.norm":"backbone.res4.5.norm2",
  "backbone.res4.5.conv3.norm":"backbone.res4.5.norm3",
  "backbone.res4.6.conv1.norm":"backbone.res4.6.norm1",
  "backbone.res4.6.conv2.norm":"backbone.res4.6.norm2",
  "backbone.res4.6.conv3.norm":"backbone.res4.6.norm3",
  "backbone.res4.7.conv1.norm":"backbone.res4.7.norm1",
  "backbone.res4.7.conv2.norm":"backbone.res4.7.norm2",
  "backbone.res4.7.conv3.norm":"backbone.res4.7.norm3",
  "backbone.res4.8.conv1.norm":"backbone.res4.8.norm1",
  "backbone.res4.8.conv2.norm":"backbone.res4.8.norm2",
  "backbone.res4.8.conv3.norm":"backbone.res4.8.norm3",
  "backbone.res4.9.conv1.norm":"backbone.res4.9.norm1",
  "backbone.res4.9.conv2.norm":"backbone.res4.9.norm2",
  "backbone.res4.9.conv3.norm":"backbone.res4.9.norm3",
  "backbone.res4.10.conv1.norm":"backbone.res4.10.norm1",
  "backbone.res4.10.conv2.norm":"backbone.res4.10.norm2",
  "backbone.res4.10.conv3.norm":"backbone.res4.10.norm3",
  "backbone.res4.11.conv1.norm":"backbone.res4.11.norm1",
  "backbone.res4.11.conv2.norm":"backbone.res4.11.norm2",
  "backbone.res4.11.conv3.norm":"backbone.res4.11.norm3",
  "backbone.res4.12.conv1.norm":"backbone.res4.12.norm1",
  "backbone.res4.12.conv2.norm":"backbone.res4.12.norm2",
  "backbone.res4.12.conv3.norm":"backbone.res4.12.norm3",
  "backbone.res4.13.conv1.norm":"backbone.res4.13.norm1",
  "backbone.res4.13.conv2.norm":"backbone.res4.13.norm2",
  "backbone.res4.13.conv3.norm":"backbone.res4.13.norm3",
  "backbone.res4.14.conv1.norm":"backbone.res4.14.norm1",
  "backbone.res4.14.conv2.norm":"backbone.res4.14.norm2",
  "backbone.res4.14.conv3.norm":"backbone.res4.14.norm3",
  "backbone.res4.15.conv1.norm":"backbone.res4.15.norm1",
  "backbone.res4.15.conv2.norm":"backbone.res4.15.norm2",
  "backbone.res4.15.conv3.norm":"backbone.res4.15.norm3",
  "backbone.res4.16.conv1.norm":"backbone.res4.16.norm1",
  "backbone.res4.16.conv2.norm":"backbone.res4.16.norm2",
  "backbone.res4.16.conv3.norm":"backbone.res4.16.norm3",
  "backbone.res4.17.conv1.norm":"backbone.res4.17.norm1",
  "backbone.res4.17.conv2.norm":"backbone.res4.17.norm2",
  "backbone.res4.17.conv3.norm":"backbone.res4.17.norm3",
  "backbone.res4.18.conv1.norm":"backbone.res4.18.norm1",
  "backbone.res4.18.conv2.norm":"backbone.res4.18.norm2",
  "backbone.res4.18.conv3.norm":"backbone.res4.18.norm3",
  "backbone.res4.19.conv1.norm":"backbone.res4.19.norm1",
  "backbone.res4.19.conv2.norm":"backbone.res4.19.norm2",
  "backbone.res4.19.conv3.norm":"backbone.res4.19.norm3",
  "backbone.res4.20.conv1.norm":"backbone.res4.20.norm1",
  "backbone.res4.20.conv2.norm":"backbone.res4.20.norm2",
  "backbone.res4.20.conv3.norm":"backbone.res4.20.norm3",
  "backbone.res4.21.conv1.norm":"backbone.res4.21.norm1",
  "backbone.res4.21.conv2.norm":"backbone.res4.21.norm2",
  "backbone.res4.21.conv3.norm":"backbone.res4.21.norm3",
  "backbone.res4.22.conv1.norm":"backbone.res4.22.norm1",
  "backbone.res4.22.conv2.norm":"backbone.res4.22.norm2",
  "backbone.res4.22.conv3.norm":"backbone.res4.22.norm3"
}

import pickle

weights = pickle.load(open("D:/Samsung/Delta-Detectron2/instance_segmentation_resnet101.pkl", 'rb'))
# weights = torch.load(open("D:/Samsung/Delta-Detectron2/model_final_298dad.pkl", 'r'), map_location='cpu')
# print(weights['model'])
keys = [k for k in weights['model']]
for k in keys:
    if 'backbone' in k:
        if not len(weights['model'][k].shape)==4:
            continue
        weights['model'][k] = weights['model'][k].transpose((1,2,3,0))

# change_keys = [k for k in changes]

# for k in change_keys:
#     value = changes[k]
#     weights['model'][value+'.bias'] = weights['model'][k+'.bias']
#     weights['model'][value+'.running_mean'] = weights['model'][k+'.running_mean']
#     weights['model'][value+'.running_var'] = weights['model'][k+'.running_var']
#     weights['model'][value+'.weight'] = weights['model'][k+'.weight']

# for k in change_keys:
#     del weights['model'][k+'.bias']
#     del weights['model'][k+'.running_mean']
#     del weights['model'][k+'.running_var']
#     del weights['model'][k+'.weight']

pickle.dump(weights, open('instance_segmentation_resnet101_channel_last.pkl', 'wb'))